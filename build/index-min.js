/*!build time : 2015-01-20 10:49:45 AM*/
KISSY.add("kg/xmenu/1.0.0/index",function(a,b,c,d,e,f){function g(a){g.superclass.constructor.call(this),this.userConfig=b.mix({maskNode:""},a),this.init()}var h=f.all;return b.extend(g,c,{init:function(){var a=this;a.renderTo=document.querySelector(a.userConfig.renderTo)||document.body,a.gradesNum=0,a.width=a.userConfig.width||a.renderTo.offsetWidth||100,a.zIndexBase=a.userConfig.zIndex||1e3,a.scrolls=[],a.currentId=0,a.formatTree(),a.render()},formatTree:function(){function a(d,e,f){e++;for(var g in d)b.totalData.push(d[g]),d[g].grade=e,d[g].id=b.id,d[g].idx=g,d[g].pid=void 0===f?"":Number(f),b.id++,d[g].children&&d[g].children.length?a(d[g].children,e,g):d[g].pageIndex=c++;e>b.gradesNum&&(b.gradesNum=e)}var b=this,c=0;b.totalData=[],b.id=0,a(b.userConfig.data,0)},createScroll:function(a){var b=this,c=document.createElement("div");c.id="XS_"+a,c.className="menu-container",c.style.width=b.width,c.style.height="100%",c.style.position="absolute",c.style.zIndex=b.zIndexBase+b.gradesNum-a,c.style.webkitTransform="translateZ(0)",c.style.left=0>a-1?0:(a-1)*b.width+"px";var d=document.createElement("div");d.className="xs-container";var f=document.createElement("div");f.className="xs-content",c.appendChild(d),d.appendChild(f),b.renderTo.appendChild(c);var g=new e({renderTo:"#"+c.id,SROLL_ACCELERATION:.001,lockX:!0,scrollbarX:!1,scrollbarY:!1});return g.renderTo.style.display="none",g.render(),b.scrolls[a]=g,g},_computPos:function(){var a=this;a.width=a.renderTo.offsetWidth;for(var b in a.xscrolls)a.xscrolls[b].renderTo.style.left=0>b-1?0:(b-1)*a.width+"px"},render:function(){var a=this,b=a.userConfig.data;a.width=a.userConfig.width||a.renderTo.offsetWidth||100;for(var c=0;c<a.gradesNum;c++)a.scrolls[c]||a.createScroll(c);a._renderSingleMenu(1,b),a._renderMask(),a._bindEvt()},_renderMask:function(){var a=this;if(!a._isMaskRendered){a._isMaskRendered=!0;var b=a.userConfig.maskNode&&document.querySelector(a.userConfig.maskNode);b||(b=document.createElement("div"),document.body.appendChild(b)),b.className="ks-sider-menu-mask",b.style.zIndex=a.zIndexBase,b.style.opacity=0,b.style.webkitTransition="all 0.5s ease",b.addEventListener("touchstart",function(b){b.preventDefault(),a.hide()},!1),a.mask=b}},showMask:function(){var a=this;a.mask.style.display="block",a.mask.style.opacity="0.5"},hideMask:function(){var a=this;a.mask.style.opacity="0"},_renderSingleMenu:function(a,b,c){var d=this,e=(d.userConfig.template,"<ul>");for(var f in b){var g=d._getData(a,f).children&&d._getData(a,f).children.length?!1:!0;e+='<li class="menu-item" data-index="'+f+'" data-id="'+b[f].id+'" data-grade="'+b[f].grade+'" data-pid="'+(c||"")+'">'+d.userConfig.renderHook.call(d,b[f])+(g?"":"<i></i>")+"</li>"}e+="</ul>",d.scrolls[a-1]&&(d.scrolls[a-1].renderTo.style.display="block",d.scrolls[a-1].content.innerHTML=e,d.scrolls[a-1].render())},pop:function(a){var b=this;if(b.scrolls[a]){var c=b.scrolls[a].renderTo;c.style.display="block",c.style.webkitTransform="translate("+b.width+"px,0) translateZ(0)",c.style.webkitTransition="-webkit-transform 0.5s ease",b.showMask()}},hide:function(a){var b=this,a=a||1;if(b.scrolls[a]){for(var c in b.scrolls)if(c>=a){var d=b.scrolls[c].renderTo;d.style.display="none",d.style.webkitTransform="translate(0,0) translateZ(0)"}1==a&&b.hideMask()}},switchTo:function(a,b,c){var d,e=this,f=a+1,g=e._getMenuData(a+1,b),i=e.scrolls[a-1],j=(i.getOffsetTop(),i.renderTo);if(c){var k=a-1,l=(e.scrolls[k-1],i.renderTo),m=l.querySelector(".cur");m&&c==m.attr("data-index")||(h(l).all("li").removeClass("cur"),h(l).all('[data-index="'+c+'"]').addClass("cur"),e._renderSingleMenu(a,e._getMenuData(a,c),1))}for(var n=j.querySelectorAll(".menu-item"),o=0;o<n.length;o++)a==n[o].getAttribute("data-grade")&&b==n[o].getAttribute("data-index")&&(d=n[o]);if(d){var p=h(j).all(".menu-item").index(h(d)),q=j.querySelector(".menu-item").offsetHeight,r=j.offsetHeight/2-q*p;r>0&&(r=0),r<i.boundry.bottom-i.containerHeight&&(r=i.boundry.bottom-i.containerHeight);var s={menu:d,data:e._getData(a,p,c)};g&&g.length?(s.isLeaf=!1,!h(d).hasClass("cur")&&e._renderSingleMenu(f,g,p),e.pop(a)):(s.isLeaf=!0,e.hide()),h(d).addClass("cur").siblings().removeClass("cur"),i.scrollY(-r,300),e.fire("switch",s)}},switchToNext:function(){var a=this;a.currentId<a.totalData.length-1&&(a.currentId++,a.switchTo(a.totalData[a.currentId].grade,a.totalData[a.currentId].idx))},switchToPrev:function(){var a=this;a.currentId>0&&(a.currentId--,a.switchTo(a.totalData[a.currentId].grade,a.totalData[a.currentId].idx))},_bindEvt:function(){var a=this;if(!a._isEvtBind){a._isEvtBind=!0,d.on(a.renderTo,"xsTap",function(b){var c=h(b.target);if(c.hasClass("menu-item")){var d=Number(c.attr("data-grade")),e=Number(c.attr("data-index")),f=Number(c.attr("data-pid"));a.switchTo(d,e,f);var g=a._getData(d,e).children&&a._getData(d,e).children.length?!1:!0;a.fire("click",{grade:d,index:e,isLeaf:g,pid:f})}});for(var b in a.scrolls)a.scrolls[b].on("refresh",function(){a.hide(),a._computPos()});document.addEventListener("webkitTransitionEnd",function(b){b.target==a.mask&&0==a.mask.style.opacity&&(a.mask.style.display="none")},!1)}},_getMenuData:function(a,b){var c=this,d=c.totalData,e=[];for(var f in d)d[f].grade==a&&d[f].pid==b&&e.push(d[f]);return e},_getData:function(a,b,c){var d=this,e=d.totalData;for(var f in e)if(e[f].grade==a&&e[f].idx==b&&(!c||c==e[f].pid))return e[f]}}),g},{requires:["kg/xscroll/2.3.1/util","kg/xscroll/2.3.1/base","kg/xscroll/2.3.1/event","kg/xscroll/2.3.1/core","node"]});